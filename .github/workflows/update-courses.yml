name: æ¯æ—¥èª²ç¨‹è³‡æ–™æ›´æ–°èˆ‡éƒ¨ç½²

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 6:00 åŸ·è¡Œï¼ˆUTC 22:00ï¼‰
    - cron: '0 22 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: è¨­ç½® Node.js ç’°å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: å¿«å– NPM ä¾è³´
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('course-helper-web/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    
    - name: å®‰è£ Python ä¾è³´å¥—ä»¶
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: åŸ·è¡Œèª²ç¨‹è³‡æ–™çˆ¬å–
      run: |
        python course_crawler.py
    
    - name: æª¢æŸ¥èª²ç¨‹è³‡æ–™æ˜¯å¦æœ‰è®Šæ›´
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain course-helper-web/public/data/)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ğŸ“Š èª²ç¨‹è³‡æ–™æœ‰æ›´æ–°ï¼"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ èª²ç¨‹è³‡æ–™ç„¡è®Šæ›´"
        fi
    
    - name: å®‰è£å‰ç«¯ä¾è³´
      run: |
        cd course-helper-web
        npm ci --prefer-offline --no-audit
    
    - name: å»ºç½®éœæ…‹ç¶²ç«™
      run: |
        cd course-helper-web
        npm run build
    
    - name: æäº¤èª²ç¨‹è³‡æ–™è®Šæ›´
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git add course-helper-web/public/data/
        git add course-helper-web/out/
        git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°èª²ç¨‹è³‡æ–™ - $(date '+%Y-%m-%d %H:%M:%S')" || echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"

    - name: æ¨é€è®Šæ›´åˆ°é ç¨‹å€‰åº«
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git push origin main || (echo "æ¨é€å¤±æ•—ï¼Œå˜—è©¦å¼·åˆ¶æ¨é€..." && git push --force-with-lease origin main)
    
    - name: è¨­ç½® GitHub Pages
      uses: actions/configure-pages@v4
    
    - name: ä¸Šå‚³éœæ…‹ç¶²ç«™æª”æ¡ˆ
      uses: actions/upload-pages-artifact@v3
      with:
        path: './course-helper-web/out'
    
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: è¼¸å‡ºçµæœæ‘˜è¦
      run: |
        echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦å ±å‘Š"
        echo "===================="
        echo "â° åŸ·è¡Œæ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“Š èª²ç¨‹è³‡æ–™æ›´æ–°: ${{ steps.verify-changed-files.outputs.changed == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }}"
        echo "ğŸŒ ç¶²ç«™éƒ¨ç½²: âœ… å®Œæˆ"
        echo "ğŸ”— ç¶²ç«™é€£çµ: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“ éƒ¨ç½²æª”æ¡ˆ: course-helper-web/out"
